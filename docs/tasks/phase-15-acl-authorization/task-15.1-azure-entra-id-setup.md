# Task 15.1: Azure Entra ID Setup

**Phase:** 15 - ACL-Based Authorization
**Estimated Time:** 30 minutes (Manual setup)
**Prerequisites:** Azure Entra ID tenant with app registration for TimeReporting API
**Status:** Pending

---

## Objective

Configure Azure Entra ID to include hierarchical ACL (Access Control List) entries in JWT access tokens using extension attributes. This enables token-based authorization without database lookups.

---

## Background

Azure Entra ID supports custom **schema extensions** that allow adding custom attributes to user objects. These attributes can be included as claims in JWT tokens, enabling fine-grained, hierarchical authorization decisions directly from the token.

**Key Concepts:**
- **Extension Attribute**: Custom user property (e.g., `extension_TimeReporting_acl`)
- **Multi-value String Array**: ACL entries stored as array of strings
- **Token Claims**: Extension attributes included in access token
- **Hierarchical Paths**: ACL entries like `Project/123=V,A` define resource paths with permissions

---

## Acceptance Criteria

- [ ] Schema extension `extension_TimeReporting_acl` created in Azure Entra ID
- [ ] Extension attribute configured with `Collection(String)` type
- [ ] Token configuration updated to include extension claim in access tokens
- [ ] Test ACL values assigned to at least one user
- [ ] Token verified using jwt.ms shows `extension_TimeReporting_acl` claim
- [ ] Documentation created with step-by-step setup instructions

---

## Implementation

### Step 1: Create Schema Extension

Use Azure CLI to create the schema extension:

```bash
# Set your app registration client ID
APP_ID="8b3f87d7-bc23-4932-88b5-f24056999600"  # Replace with your app ID

# Create schema extension
az rest --method post \
  --uri https://graph.microsoft.com/v1.0/schemaExtensions \
  --body "{
    \"id\": \"TimeReporting\",
    \"description\": \"Per-user ACL entries for Time Reporting\",
    \"targetTypes\": [\"User\"],
    \"properties\": [
      {
        \"name\": \"acl\",
        \"type\": \"Collection(String)\"
      }
    ],
    \"owner\": \"$APP_ID\"
  }"
```

**Expected Response:**
```json
{
  "id": "extABCDEF_TimeReporting",
  "description": "Per-user ACL entries for Time Reporting",
  "targetTypes": ["User"],
  "status": "Available",
  "properties": [
    {
      "name": "acl",
      "type": "Collection(String)"
    }
  ]
}
```

**Note:** The full extension name will be `extABCDEF_TimeReporting` where `ABCDEF` is generated by Azure. Save this full name for later use.

### Step 2: Assign ACL Values to Users

Assign ACL entries to a test user:

```bash
# Get user ID
USER_EMAIL="your.email@example.com"
USER_ID=$(az ad user show --id $USER_EMAIL --query id -o tsv)

# Assign ACL values
az rest --method patch \
  --uri "https://graph.microsoft.com/v1.0/users/$USER_ID" \
  --body '{
    "extension_TimeReporting_acl": [
      "Project/INTERNAL=V,A,M",
      "Project/CLIENT-A=V,E,T",
      "Project/MAINT=V"
    ]
  }'
```

**ACL Entry Format:**
- **Path**: Hierarchical resource identifier (e.g., `Project/INTERNAL`, `Project/CLIENT-A/Task/123`)
- **Permissions**: Comma-separated abbreviations:
  - `V` = View (read access)
  - `E` = Edit (modify time entries)
  - `A` = Approve (approve/decline time entries)
  - `M` = Manage (admin operations)
  - `T` = Track (log time entries)

**Examples:**
```
"Project/INTERNAL=V,A,M"           # Can view, approve, manage INTERNAL project
"Project/CLIENT-A=V,E,T"           # Can view, edit, track CLIENT-A project
"Project/CLIENT-A/Task/123=V,E"    # Can view, edit specific task
"Report/2024-Q1=V"                 # Can view specific report (future use)
```

### Step 3: Configure Token to Include Extension Claim

1. Go to **Azure Portal** → **Azure Entra ID** → **App registrations**
2. Select your **TimeReporting API** app registration
3. Navigate to **Token configuration**
4. Click **Add optional claim**
5. Select **Access token** type
6. Find and select `extension_TimeReporting_acl` from the list
7. Check **Turn on the Microsoft Graph profile permission (required for claims to appear in token)**
8. Click **Add**

**Alternative via PowerShell:**
```powershell
# Get application object ID
$appObjectId = (Get-AzureADApplication -Filter "appId eq '8b3f87d7-bc23-4932-88b5-f24056999600'").ObjectId

# Add optional claim
$optionalClaims = @{
    AccessToken = @(
        @{
            Name = "extension_TimeReporting_acl"
            Source = "user"
            Essential = $false
        }
    )
}

Set-AzureADApplication -ObjectId $appObjectId -OptionalClaims $optionalClaims
```

### Step 4: Verify Token Contains Claim

**Method 1: Using jwt.ms**

1. Acquire an access token for your API:
   ```bash
   az account get-access-token \
     --resource api://8b3f87d7-bc23-4932-88b5-f24056999600 \
     --query accessToken -o tsv
   ```

2. Copy the token and paste it into **https://jwt.ms**

3. Verify the decoded token contains:
   ```json
   {
     "oid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
     "email": "your.email@example.com",
     "extension_TimeReporting_acl": [
       "Project/INTERNAL=V,A,M",
       "Project/CLIENT-A=V,E,T",
       "Project/MAINT=V"
     ]
   }
   ```

**Method 2: Using curl**

```bash
# Get token
TOKEN=$(az account get-access-token \
  --resource api://8b3f87d7-bc23-4932-88b5-f24056999600 \
  --query accessToken -o tsv)

# Decode token (requires jq)
echo $TOKEN | cut -d'.' -f2 | base64 -d | jq .
```

---

## Testing

### Verification Checklist

- [ ] Schema extension created successfully
- [ ] User ACL values assigned (verify with Graph API)
- [ ] Token configuration updated in app registration
- [ ] Token contains `extension_TimeReporting_acl` claim
- [ ] ACL entries are in correct format (`Path=Perm1,Perm2`)

### Common Issues

**Issue 1: Claim not appearing in token**
- **Solution**: Ensure "Turn on Microsoft Graph profile permission" is enabled in token configuration
- **Solution**: Wait 5 minutes for changes to propagate
- **Solution**: Use `--resource api://YOUR_APP_ID` (not Microsoft Graph resource)

**Issue 2: Extension attribute not found**
- **Solution**: Use full extension name `extABCDEF_TimeReporting_acl` (not just `extension_TimeReporting_acl`)
- **Solution**: Check extension status is "Available" (not "InDevelopment")

**Issue 3: Permission denied when creating extension**
- **Solution**: Ensure you have `Application.ReadWrite.All` permission in Microsoft Graph
- **Solution**: Use app owner account or Global Administrator role

---

## Related Files

**Created:**
- None (Azure Entra ID configuration only)

**Documentation:**
- `docs/tasks/phase-15-acl-authorization/AZURE-SETUP-GUIDE.md` (created in Task 15.7)

---

## Integration Points

The extension attribute configured in this task will be used by:
- **Task 15.2**: `AclExtensions.cs` will parse these claims
- **Task 15.4**: Mutations will check permissions using these claims
- **Task 15.5**: Slash commands will manage these values via Graph API

---

## Validation

After completing this task:

1. ✅ Extension attribute exists in Azure Entra ID
2. ✅ At least one user has ACL values assigned
3. ✅ Token includes `extension_TimeReporting_acl` claim with correct format
4. ✅ You can decode the token and see ACL entries

---

## Next Steps

After completing Task 15.1:
- **Task 15.2:** Create `AclExtensions.cs` helper to parse and validate ACL claims
- **Task 15.3:** Configure ASP.NET Core to properly map JWT claims

---

## Notes

- **Token Size**: Each ACL entry ~30-50 bytes. With 100 entries, token size ≈ 3-5 KB (well under 24 KB limit)
- **Token Lifetime**: Access tokens are 5 minutes, refresh tokens longer-lived
- **Propagation Time**: Changes to extension attributes may take 5-10 minutes to appear in new tokens
- **Permissions Required**: To manage schema extensions, you need `Application.ReadWrite.All` in Microsoft Graph
- **Extension ID**: The `id` field in the schema extension will have a prefix added (e.g., `extABCDEF_`)
- **Multi-Tenant**: Schema extensions are tenant-scoped, not global

---

## Reference

- [Azure AD Schema Extensions Documentation](https://learn.microsoft.com/en-us/graph/extensibility-schema-groups)
- [Configure Optional Claims](https://learn.microsoft.com/en-us/entra/identity-platform/optional-claims)
- [JWT Token Claims Customization](https://learn.microsoft.com/en-us/entra/identity-platform/jwt-claims-customization)

using System.Text.Json;
using TimeReportingMcpSdk.Generated;

namespace TimeReportingMcpSdk.Utils;

/// <summary>
/// Formats TimeEntry data into consistent JSON responses across all MCP tools.
/// Uses the ITimeEntryFields interface from StrawberryShake entity type generation.
/// </summary>
public static class TimeEntryFormatter
{
    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true
    };

    /// <summary>
    /// Format a single TimeEntry as JSON.
    /// Uses the strongly-typed ITimeEntryFields interface generated by StrawberryShake.
    /// All GraphQL operations that use ...TimeEntryFields fragment return types that implement this interface.
    /// </summary>
    /// <param name="entry">TimeEntry object implementing ITimeEntryFields</param>
    /// <returns>JSON string with all TimeEntry fields</returns>
    public static string FormatAsJson(ITimeEntryFields entry)
    {
        // Extract tags - no casts needed, using interface properties directly
        var tagArray = entry.Tags?.Select(t => new
        {
            name = t.TagValue.ProjectTag.TagName,
            value = t.TagValue.Value
        }).ToArray() ?? Array.Empty<object>();

        var jsonEntry = new
        {
            id = entry.Id.ToString(),
            projectCode = entry.Project.Code,
            projectName = entry.Project.Name,
            task = entry.ProjectTask.TaskName,
            standardHours = entry.StandardHours,
            overtimeHours = entry.OvertimeHours,
            startDate = entry.StartDate.ToString("yyyy-MM-dd"),
            completionDate = entry.CompletionDate.ToString("yyyy-MM-dd"),
            status = entry.Status.ToString(),
            declineComment = entry.DeclineComment,
            description = entry.Description,
            issueId = entry.IssueId,
            userId = entry.UserId,
            userEmail = entry.UserEmail,
            userName = entry.UserName,
            tags = tagArray,
            createdAt = entry.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss"),
            updatedAt = entry.UpdatedAt.ToString("yyyy-MM-dd HH:mm:ss")
        };

        return JsonSerializer.Serialize(jsonEntry, JsonOptions);
    }

    /// <summary>
    /// Format multiple TimeEntry objects as JSON array.
    /// Uses the strongly-typed ITimeEntryFields interface generated by StrawberryShake.
    /// </summary>
    /// <param name="entries">Collection of TimeEntry objects implementing ITimeEntryFields</param>
    /// <returns>JSON array string</returns>
    public static string FormatAsJsonArray(IEnumerable<ITimeEntryFields> entries)
    {
        var jsonEntries = entries.Select(entry => new
        {
            id = entry.Id.ToString(),
            projectCode = entry.Project.Code,
            projectName = entry.Project.Name,
            task = entry.ProjectTask.TaskName,
            standardHours = entry.StandardHours,
            overtimeHours = entry.OvertimeHours,
            startDate = entry.StartDate.ToString("yyyy-MM-dd"),
            completionDate = entry.CompletionDate.ToString("yyyy-MM-dd"),
            status = entry.Status.ToString(),
            declineComment = entry.DeclineComment,
            description = entry.Description,
            issueId = entry.IssueId,
            userId = entry.UserId,
            userEmail = entry.UserEmail,
            userName = entry.UserName,
            tags = entry.Tags?.Select(t => new
            {
                name = t.TagValue.ProjectTag.TagName,
                value = t.TagValue.Value
            }).ToArray() ?? Array.Empty<object>(),
            createdAt = entry.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss"),
            updatedAt = entry.UpdatedAt.ToString("yyyy-MM-dd HH:mm:ss")
        }).ToList();

        return JsonSerializer.Serialize(jsonEntries, JsonOptions);
    }
}
